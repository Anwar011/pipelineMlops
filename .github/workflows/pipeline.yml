name: MLOps Pipeline

on:
  push:
    branches:
      - main
    paths:
      - 'data/raw.dvc'
      - '.dvc/**'
      - 'data/raw/**'
  workflow_dispatch:  # Trigger manuel pour tests

jobs:
  train-and-deploy:
    runs-on: self-hosted  # Utiliser self-hosted runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Setup Python (if not available)
      shell: cmd
      run: |
        @echo off
        where python3 >nul 2>&1
        if %ERRORLEVEL% EQU 0 (
          python3 --version
          goto :end
        )
        where python >nul 2>&1
        if %ERRORLEVEL% EQU 0 (
          python --version
          goto :end
        )
        echo Python3 non trouvé, installation requise
        exit /b 1
        :end
    
    - name: Install dependencies
      shell: cmd
      run: |
        @echo off
        where python3 >nul 2>&1
        if %ERRORLEVEL% EQU 0 (
          python3 -m pip install --upgrade pip --user
          python3 -m pip install -r requirements.txt --user
        ) else (
          python -m pip install --upgrade pip --user
          python -m pip install -r requirements.txt --user
        )
        set "PATH=%USERPROFILE%\.local\bin;%PATH%"
    
    - name: Install DVC (if not available)
      shell: cmd
      run: |
        @echo off
        where dvc >nul 2>&1
        if %ERRORLEVEL% NEQ 0 (
          where python3 >nul 2>&1
          if %ERRORLEVEL% EQU 0 (
            python3 -m pip install "dvc[s3]" --user
          ) else (
            python -m pip install "dvc[s3]" --user
          )
          set "PATH=%USERPROFILE%\.local\bin;%PATH%"
        )
    
    - name: Setup DVC
      shell: cmd
      run: |
        @echo off
        set "PATH=%USERPROFILE%\.local\bin;%PATH%"
        dvc remote modify local --local url ./dvc_storage 2>nul
        if %ERRORLEVEL% NEQ 0 (
          echo Remote config failed, continuons...
        )
        dvc pull 2>nul
        if %ERRORLEVEL% NEQ 0 (
          echo Pas de donnees DVC disponibles, continuons...
        )
        exit /b 0
    
    - name: Check for data changes with DVC
      id: check_dvc
      shell: cmd
      run: |
        @echo off
        set "PATH=%USERPROFILE%\.local\bin;%PATH%"
        if "%{{ github.event_name }}"=="workflow_dispatch" (
          echo changed=true >> "%GITHUB_OUTPUT%"
          echo Changements de donnees detectes ou trigger manuel
          exit /b 0
        )
        dvc status data/raw.dvc 2>nul | findstr /C:"data/raw.dvc" /C:"changed" >nul
        if %ERRORLEVEL% EQU 0 (
          echo changed=true >> "%GITHUB_OUTPUT%"
          echo Changements de donnees detectes
        ) else (
          echo changed=false >> "%GITHUB_OUTPUT%"
          echo Pas de changements de donnees
        )
        exit /b 0
    
    - name: Prepare data
      if: steps.check_dvc.outputs.changed == 'true'
      shell: cmd
      run: |
        @echo off
        set "PYTHONPATH=."
        set "PATH=%USERPROFILE%\.local\bin;%PATH%"
        where python3 >nul 2>&1
        if %ERRORLEVEL% EQU 0 (
          python3 scripts/prepare_data.py
        ) else (
          python scripts/prepare_data.py
        )
    
    - name: Verify MLflow is running
      if: steps.check_dvc.outputs.changed == 'true'
      shell: cmd
      run: |
        @echo off
        echo Vérification que MLflow est accessible...
        curl -f http://localhost:5000/health >nul 2>&1
        if %ERRORLEVEL% NEQ 0 (
          echo [ERREUR] MLflow n'est pas accessible sur http://localhost:5000
          echo Veuillez démarrer MLflow avec: cd docker ^&^& docker-compose up -d mlflow
          exit /b 1
        )
        echo [OK] MLflow est accessible
    
    - name: Train model
      if: steps.check_dvc.outputs.changed == 'true'
      shell: cmd
      run: |
        @echo off
        set "PYTHONPATH=."
        set "PATH=%USERPROFILE%\.local\bin;%PATH%"
        where python3 >nul 2>&1
        if %ERRORLEVEL% EQU 0 (
          python3 src/training/train.py --config configs/config.yaml
        ) else (
          python src/training/train.py --config configs/config.yaml
        )
    
    - name: Verify model in MLflow
      if: steps.check_dvc.outputs.changed == 'true'
      shell: cmd
      run: |
        @echo off
        set "PYTHONPATH=."
        set "PATH=%USERPROFILE%\.local\bin;%PATH%"
        where python3 >nul 2>&1
        if %ERRORLEVEL% EQU 0 (
          python3 scripts/verify_mlflow.py
        ) else (
          python scripts/verify_mlflow.py
        )
    
    - name: Get latest model from MLflow
      if: steps.check_dvc.outputs.changed == 'true'
      shell: cmd
      run: |
        @echo off
        set "PYTHONPATH=."
        set "PATH=%USERPROFILE%\.local\bin;%PATH%"
        where python3 >nul 2>&1
        if %ERRORLEVEL% EQU 0 (
          python3 scripts/get_latest_model.py --tracking-uri http://localhost:5000 --experiment-name plant_disease_mvp --output-file models/best_model.pth
        ) else (
          python scripts/get_latest_model.py --tracking-uri http://localhost:5000 --experiment-name plant_disease_mvp --output-file models/best_model.pth
        )
    
    - name: Build Docker image
      if: steps.check_dvc.outputs.changed == 'true'
      shell: cmd
      run: |
        @echo off
        docker build -t plant-disease-api:${{ github.sha }} -f docker/Dockerfile .
        docker tag plant-disease-api:${{ github.sha }} plant-disease-api:latest
        echo [OK] Image Docker buildée: plant-disease-api:${{ github.sha }}
    
    - name: Deploy to Kubernetes
      if: steps.check_dvc.outputs.changed == 'true'
      shell: cmd
      run: |
        @echo off
        where kubectl >nul 2>&1
        if %ERRORLEVEL% NEQ 0 (
          echo [ERREUR] kubectl n'est pas installé
          exit /b 1
        )
        
        kubectl apply -f k8s/
        
        kubectl set image deployment/plant-disease-api api=plant-disease-api:${{ github.sha }} -n plant-disease-mlops || echo Deployment non trouvé, création en cours...
        
        kubectl rollout status deployment/plant-disease-api -n plant-disease-mlops --timeout=300s || echo Rollout timeout
        
        echo [OK] Déploiement terminé
